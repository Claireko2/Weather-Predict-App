<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Visualization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            min-height: 100vh;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .main-container {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }

        .left-panel,
        .right-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .left-panel {
            flex: 2;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .weather-info h2 {
            margin: 15px 0;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid #00b894;
        }

        .rain-forecast-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .gauge-container {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .gauge-value {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        #weather-visualization {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .update-btn {
            display: block;
            margin: 20px auto;
            padding: 12px 25px;
            font-size: 1em;
            font-weight: bold;
            color: white;
            background: #00b894;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, background 0.3s ease;
        }

        .update-btn:hover {
            background: #019875;
            transform: scale(1.05);
        }

        /* Summary Statistics Styling */
        #summary {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        #summary h2 {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
        }

        .stat-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .stat-values {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
        }

        .stat-value {
            text-align: center;
        }

        .stat-value-label {
            font-size: 0.8em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .stat-value-number {
            font-size: 1.2em;
            font-weight: bold;
        }

        .chart-container {
            height: 120px;
            margin-top: 10px;
            position: relative;
        }

        .summary-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .overview-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .overview-title {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .overview-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .gauge-container {
                width: 150px;
                height: 150px;
            }

            .gauge-value {
                font-size: 1.5em;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .summary-overview {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
    <script>
        let summaryCharts = {};

        async function updateWeather() {
            // Call backend to collect new data
            await fetch("/collect");
            await fetch("/collect-historical");

            // Reload visualization
            window.location.reload();
        }

        function createRainGauge(percentage) {
            const ctx = document.getElementById('rainGauge').getContext('2d');

            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, '#ff7675');
            gradient.addColorStop(0.5, '#fdcb6e');
            gradient.addColorStop(1, '#00b894');

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [percentage, 100 - percentage],
                        backgroundColor: [gradient, 'rgba(255, 255, 255, 0.1)'],
                        borderWidth: 0,
                        cutout: '70%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    rotation: -90,
                    circumference: 180,
                    animation: { animateRotate: true, duration: 2000 }
                }
            });
        }

        function createMiniChart(canvasId, data, color, label) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            // Clean up existing chart if it exists
            if (summaryCharts[canvasId]) {
                summaryCharts[canvasId].destroy();
            }

            summaryCharts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Min', 'Mean', 'Max'],
                    datasets: [{
                        data: [data.min, data.mean, data.max],
                        backgroundColor: [
                            color + '60',  // Light version for min
                            color + '80',  // Medium version for mean
                            color + 'FF'   // Full version for max
                        ],
                        borderColor: color + 'FF',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function (context) {
                                    return label + ' - ' + context[0].label;
                                },
                                label: function (context) {
                                    return context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            display: false,
                            beginAtZero: data.min >= 0
                        },
                        x: {
                            display: true,
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.8)',
                                font: { size: 10 }
                            },
                            grid: { display: false }
                        }
                    },
                    elements: {
                        bar: {
                            borderWidth: 1,
                        }
                    }
                }
            });
        }

        function getMetricIcon(metric) {
            const icons = {
                'rainfall': '🌧️',
                'temperature': '🌡️',
                'humidity': '💧',
                'predicted_rain_chance': '🔮'
            };
            return icons[metric] || '📊';
        }

        function getMetricColor(metric) {
            const colors = {
                'rainfall': '#3498db',
                'temperature': '#e74c3c',
                'humidity': '#9b59b6',
                'predicted_rain_chance': '#f39c12'
            };
            return colors[metric] || '#95a5a6';
        }

        function getMetricUnit(metric) {
            const units = {
                'rainfall': 'mm',
                'temperature': '°C',
                'humidity': '%',
                'predicted_rain_chance': '%'
            };
            return units[metric] || '';
        }

        async function loadSummary() {
            const summaryContainer = document.getElementById("summary-content");
            summaryContainer.innerHTML = '<div class="loading">📊 Loading summary statistics...</div>';

            try {
                const response = await fetch("/summary_statistics");

                // Check if response is ok and is JSON
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error("Response is not JSON format");
                }

                const data = await response.json();

                if (data.status === "success" && data.summary_statistics) {
                    const stats = data.summary_statistics;

                    // Create overview cards
                    let overviewHTML = '<div class="summary-overview">';
                    let totalMetrics = Object.keys(stats).length;

                    // Add overview cards
                    overviewHTML += `
                        <div class="overview-card">
                            <div class="overview-title">📈 Metrics Tracked</div>
                            <div class="overview-value">${totalMetrics}</div>
                        </div>
                        <div class="overview-card">
                            <div class="overview-title">⏱️ Time Period</div>
                            <div class="overview-value">24h</div>
                        </div>
                    `;

                    // Add current conditions if available
                    if (stats.temperature) {
                        overviewHTML += `
                            <div class="overview-card">
                                <div class="overview-title">🌡️ Avg Temp</div>
                                <div class="overview-value">${stats.temperature.mean.toFixed(1)}°C</div>
                            </div>
                        `;
                    }
                    if (stats.humidity) {
                        overviewHTML += `
                            <div class="overview-card">
                                <div class="overview-title">💧 Avg Humidity</div>
                                <div class="overview-value">${stats.humidity.mean.toFixed(0)}%</div>
                            </div>
                        `;
                    }

                    overviewHTML += '</div>';

                    // Create detailed stat cards
                    let cardsHTML = '<div class="summary-grid">';

                    for (const metric in stats) {
                        const s = stats[metric];
                        const icon = getMetricIcon(metric);
                        const color = getMetricColor(metric);
                        const unit = getMetricUnit(metric);
                        const canvasId = `chart-${metric}`;

                        cardsHTML += `
                            <div class="stat-card">
                                <div class="stat-title">
                                    ${icon} ${metric.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                </div>
                                <div class="stat-values">
                                    <div class="stat-value">
                                        <div class="stat-value-label">Min</div>
                                        <div class="stat-value-number">${s.min.toFixed(2)}${unit}</div>
                                    </div>
                                    <div class="stat-value">
                                        <div class="stat-value-label">Mean</div>
                                        <div class="stat-value-number">${s.mean.toFixed(2)}${unit}</div>
                                    </div>
                                    <div class="stat-value">
                                        <div class="stat-value-label">Max</div>
                                        <div class="stat-value-number">${s.max.toFixed(2)}${unit}</div>
                                    </div>
                                </div>
                                <div class="chart-container">
                                    <canvas id="${canvasId}"></canvas>
                                </div>
                                <div style="font-size: 0.8em; opacity: 0.7; margin-top: 10px;">
                                    Variance: ${s.var.toFixed(3)}
                                </div>
                            </div>
                        `;
                    }

                    cardsHTML += '</div>';

                    summaryContainer.innerHTML = overviewHTML + cardsHTML;

                    // Create mini charts for each metric
                    setTimeout(() => {
                        for (const metric in stats) {
                            const canvasId = `chart-${metric}`;
                            const color = getMetricColor(metric);
                            const label = metric.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                            createMiniChart(canvasId, stats[metric], color, label);
                        }
                    }, 100);

                } else {
                    summaryContainer.innerHTML = `
                        <div class="loading">
                            📊 No summary data available yet.<br>
                            <small>Try updating weather data first or check if /summary_statistics endpoint exists.</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading summary:', error);

                // More specific error handling
                let errorMessage = "❌ Error loading summary statistics.<br>";
                if (error.message.includes("JSON")) {
                    errorMessage += "<small>The /summary_statistics endpoint may not exist or is returning HTML instead of JSON.</small>";
                } else if (error.message.includes("HTTP error")) {
                    errorMessage += "<small>Server error: " + error.message + "</small>";
                } else {
                    errorMessage += "<small>Network error. Please check your connection and try again.</small>";
                }

                document.getElementById("summary-content").innerHTML = `
                    <div class="loading">
                        ${errorMessage}<br><br>
                        <button onclick="loadSummary()" style="
                            padding: 8px 16px; 
                            background: #00b894; 
                            color: white; 
                            border: none; 
                            border-radius: 5px; 
                            cursor: pointer;
                            font-size: 0.9em;
                        ">🔄 Retry</button>
                    </div>
                `;
            }
        }

        // Initialize everything when page loads
        window.onload = function () {
            const rainForecastText = '{{ rain_forecast }}';
            const rainPercentage = parseFloat(rainForecastText) || 0;
            createRainGauge(rainPercentage);
            document.getElementById('gaugeValue').textContent = rainPercentage + '%';

            // Load summary statistics
            loadSummary();
        };
    </script>
</head>

<body>
    <h1>Weather Data Visualization</h1>

    <!-- Button to trigger /collect and /collect-historical -->
    <button class="update-btn" onclick="updateWeather()">🔄 Update Weather Data</button>

    <div class="main-container">
        <div class="left-panel">
            <div class="weather-info">
                <h2>📍 Current Location: {{ city }}</h2>
                <h2>🌡️ Temperature: {{ current_temp }}°C</h2>
                <h2>💧 Humidity: {{ current_humidity }}%</h2>
                <h2>🌧️ Rain: {{ current_rain }} mm</h2>
                <h2>🕒 Current Time: {{ current_time }}</h2>
            </div>
        </div>

        <div class="right-panel">
            <h2 class="rain-forecast-title">🔮 Predicted Rain Chance</h2>
            <div class="gauge-container">
                <canvas id="rainGauge"></canvas>
                <div class="gauge-value" id="gaugeValue">{{ rain_forecast }}</div>
            </div>
        </div>
    </div>

    <div id="weather-visualization">
        {{ plot_html | safe }}
    </div>

    <div id="summary">
        <h2>📊 Summary Statistics (Last 24h)</h2>
        <div id="summary-content">
            <div class="loading">📊 Loading summary statistics...</div>
        </div>
    </div>

</body>

</html>